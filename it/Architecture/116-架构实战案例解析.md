116-架构实战案例解析

架构本质
通过合理的内部编排，保证系统高度有序，能够不断扩展，满足业务和技术的变化。
首先，架构的出发点是业务和技术在不断复杂化，引起系统混乱，需要通过架构来保证有序。
其次，架构实现从无序到有序，是通过合理的内部编排实现的，基本的手段，就是“分”与“合”，先把系统打散，然后将它们重新组合，形成更合理的关系。
分类
业务架构：概念
业务架构就是讲清楚核心业务的处理过程，定义各个业务模块的相互关系，它从概念层面帮助我们理解系统面临哪些问题以及如何处理
应用架构：逻辑
应用架构就是讲清楚系统内部是怎么组织的，有哪些应用，相互间是怎么调用的，它从逻辑层面帮助我们理解系统内部是如何分工与协作的
技术架构：物理
技术架构就是讲清楚系统由哪些硬件、操作系统和中间件组成，它们是如何和我们开发的应用一起配合，应对各种异常情况，保持系统的稳定可用。
好的架构要求
业务复杂性
满足业务的可扩展、可复用
技术复杂性
满足系统的高可用、高性能和可伸缩，并尽量采用低成本的方式落地。
好的架构师要求
TA 必定是一个出色的程序员，写的一手好代码
需要有思维的高度，具备抽象思维能力
思维的深度，能够透过问题看本质：一个跨网络调用，知道数据是如何通过各种介质（比如网卡端口）到达目标位置
具备良好的沟通能力（感性）
良好的平衡取舍能力（理性）
业务架构
概念
可扩展架构
概念
案例一:电商平台的架构演变
单体架构 2000年
特点
                             架构图
单体应用内部一般采用分层结构，从上到下，一般分为表示层、业务层、数据访问层、DB 层。
单体架构在水平方向上，通过层次化的划分，降低了业务的深度复杂性； 不过在垂直方向上，单体应用缺乏清晰的边界，上下层模块之间是多对多的网状依赖关系
在单体架构中，模块结构是否合理，很大程度上依赖于开发者的个人水平。
优点
快速落地
项目初期，适应快速验证市场
弊端
业务系统的体量变大时，弊端就会暴露
1、多团队并行开发的话，需要额外的资源来协调不同团队之间的并行开发和上线。
2、代码合并和编译非常复杂
分布式 2006年
特点
                         架构图
分布式架构，简单来说就是系统由多个独立的应用组成，它们互相协作，成为一个整体。
在分布式架构中，API 接口属于应用的一部分，它和表示层共享底层的业务逻辑
把一个大系统的业务复杂度，分割成多个小业务的复杂度，从而降低了整体的复杂度。
分布式架构适用于业务相关性低、耦合少的业务系统
优点
通过拆分后，各个应用之间的耦合度低，就可以很好地支持多团队的并行开发。
弊端
作为应用的开发者，除了要满足自身业务的需求之外，同时还需要考虑外部业务的需求，这两部分经常会打架。
每个应用都是从头到尾，自搭一套完整的体系，导致业务之间重复造轮子，造成资源浪费。
SOA 2009年
传统SOA
目的
它解决的是企业内部大量异构系统集成的问题
特点
                                         架构图
让各个系统通过提供标准的服务，来满足外部调用需求。
外部系统通过这个服务访问系统内部，解决不同系统相互集成的问题
新 SOA 
目的
它解决的是系统重复建设的问题
特点
                                   架构图
它通过服务化思想，提供更好的业务封装性，并通过标准技术，能更友好地对外输出业务能力；
SOA 服务不依附于某个具体应用，它可以独立地部署和扩展，这样避免了直接影响现有的系统；
服务通过封装通用的业务逻辑，可以供所有应用共享，解决了重复造轮子的问题。
弊端
然而 SOA 服务化的思想很好，但在系统实现上比较重，落地比较困难。
微服务 2014年
特点
                                 架构图
相对于SOA架构，思想是相似的，但是架构更轻，但两者不同的地方在于，微服务是去中心化的，不需要 SOA 架构中 ESB 的集中管理方式。这就需要不同的通讯方式
每个微服务，都是负责端到端的业务
包括前端的 UI 展现部分和后端业务逻辑。由这个小团队负责应用的整个生命周期管理。
从一定程度上说，微服务叫做微应用，微产品，是拆分得更细的分布式架构
微服务强调围绕业务，进行清晰的业务和数据边界划分，并通过良好定义的接口输出业务能力
微服务强调所谓的哑管道，通过 HTTP 等简单的技术手段就可以访问
微服务强调智能终端，所有的业务逻辑包含在微服务内部，不需要额外的中间层提供业务规则处理
微服务 = 小应用 + 小服务
实际而言侧重小服务
很难把一个大系统，按照端到端业务的方式，拆分为一个个应用
需要把现有的职能团队打散后重组，这种人员组织的调整实际上也很难落地。
实践方法：弱化微服务的小应用定位，然后扩大化微服务小服务的定位
封装底层基础业务的是共享微服务
封装流程的是聚合微服务
封装具体业务场景的服务端是应用微服务
封装基础中间件（如 Redis 缓存、消息推送）的是系统微服务
中台 2018年
产生背景
中台适用场景
中台落地模式
案例二：一号店app端架构演变
可复用架构
概念
复用分类
如何实现？首要划分基础服务边界
案例一：如何设计一个基础服务
案例二：如何对现有系统做微服务改造
案例三：中台如何练成
技术架构
概念
高可用架构
概念
系统的故障点
资源不可用，包括网络和服务器出故障，网络出故障表明节点连接不上，服务器出故障表明该节点本身不能正常工作
资源不足，常规的流量进来，节点能正常工作，但在高并发的情况下，节点无法正常工作，对外表现为响应超时。
节点的功能有问题，这个主要体现在我们开发的代码上，比如它的内部业务逻辑有问题，或者是接口不兼容导致客户端调用出了问题；另外有些不够成熟的中间件，有时也会有功能性问题
系统故障解决思路
避免发生：我们可以通过 UPS（Uninterruptible Power System，不间断电源）来避免服务器断电，可以通过事先增加机器来解决硬件资源不足的问题。
故障转移：比如说，我们可以通过冗余部署，当一个节点发生故障时，用其它正常的节点来代替问题节点。
降低影响：比如说流量太大，我们可以通过限流，来保证部分用户可以正常使用，或者通过业务降级的手段，关闭一些次要功能，保证核心功能仍旧可用。
快速恢复：我们要尽快找到问题的原因，然后修复故障节点，使系统恢复到正常状态。
ps:处理线上事故的首要原则是先尽快恢复业务，而不是先定位系统的问题，再通过解决问题来恢复系统。
高可用架构原则
正面保障
冗余无单点
我们要保证系统的各个节点在部署时是冗余的，没有单点
水平扩展
很多时候，系统的不可用都是因为流量引起的：在高并发的情况下，系统往往会整体瘫痪，完全不可用。
减少损失
柔性事务
在很多业务场景中，系统的可用性比数据的实时一致性更重要
系统可降级
限流：让部分用户流量进入系统处理，其它流量直接抛弃
降级：系统抛弃部分不重要的功能，比如不发送短信通知，以此确保核心功能不受影响。
熔断：我们不去调用出问题的服务，让系统绕开故障点
功能禁用：针对具体的功能，我们设置好功能开关，让代码根据开关设置，灵活决定是否执行这部分逻辑。比如商品搜索，在系统繁忙时，我们可以选择不进行复杂的深度搜索。
做好监控
系统可监控
通过监控，我们可以实时地了解系统的当前状态
高可用手段
客户端 -> 接入层
首先要解决网络的可用性问题：可以拉多条线路，比如在企业私有的 IDC 机房和公有云之间，同时拉移动和电信的线路
可以选择 Nginx、HAProxy、LVS 等负载均衡软件，它们都能很好地支持双节点 +Keepalived 部署
通过冗余和自动切换避免了单点的故障
接入层 ->Web 应用
Web 应用通常是无状态的，我们可以部署多个实例，很方便地通过水平扩展的方式，提升系统的处理能力
接入层的负载均衡设备，可以通过各种算法进行多个 Web 实例的路由，并且对它们进行健康检测，如果某个实例有问题，请求可以转发到另一个实例进行处理，从而实现故障的自动转移。
还可以在接入层做限流，比如，在 Nginx 中设置每秒多少个并发的限制，超过这个并发数，Nginx 就直接返回错误
同时支持了 Web 节点的水平扩展、自动故障转移以及系统的可降级（限流）
Web 应用 -> 内部服务
服务通常也是无状态的，我们也可以通过部署多个实例进行水平扩展
可以使用传统的代理服务器方式，进行请求分发
很多的微服务框架本身就支持服务的直接路由，比如在 Spring Cloud 中，我们就可以通过 Eureka 进行服务的自动注册和路由
我们可以为不同服务配置不同的线程池，实现资源隔离，避免因为一个服务响应慢，而占用所有的线程资源；如果某个服务调用失败，我们可以对它进行熔断操作，避免无谓的超时等待，影响调用方的整体性能。
针对具体的功能，我们还可以做一些功能开关。开关实际上是一个标志变量，它的值可以是 on/off， 我们在代码中可以根据它的值，来确定某一段逻辑是否要执行。开关的值可以在数据库或配置系统里定义，这样我们就能够通过外部的开关值，控制应用内部的行为，
同时支持了服务节点的水平扩展、自动故障转移以及系统的可降级（熔断和业务开关）。
访问基础资源
关系数据库
主从部署，一方面通过读写分离，提升数据库读的性能，减轻主库压力
另一方面，数据库有成熟的 MHA 方案，支持主库故障时，能够自动实现主从切换，应用可以通过 VIP 访问数据库
物理的水平分库方式，对数据进行分片，这样就有多个主库支持写入
缓存
数据读写比很高的情况下，我们可以利用缓存优化数据库的访问性能，包括进程内部缓存和分布式缓存，缓存是应对高并发的有效武器。
通过多节点支持处理能力的水平扩展，通过数据的多副本来支持故障转移
消息系统
通过多节点部署来支持处理能力的水平扩展，也能通过数据的多分区，实现故障的自动切换
案例一：实现O2O平台24小时在线
案例二：如何第一时间知道系统哪里有问题
案例三：打造一体化监控系统
高性能和可伸缩架构
概念
高性能架构案例
可伸缩架构案例
一个综合案例：互联网平台技术架构演变
点击标题旁+ 可查看前期课程总结